实习日记

2020年8月24日

开完动员会，项目组老师说可以不局限于国际象棋和围棋的对弈范围，所以考虑到了之前打算做misamino仿制的计划，基本上打算做一个类misamino的PVE/EVE俄罗斯方块对弈程序

考虑到多平台的可移植性，项目选择了基于lua语言的Love2d引擎，在ZeroBrane Studio环境下进行制作，之前制作过许多横板demo，再考虑到之前在人工智能课程设计的解迷宫程序的经验，基于DFS、A*算法的规划思路也还算清晰，对项目还是有一些信心的

下午一点开始构建，现在是25日凌晨01点20分

严格根据Trtris-guideline-docs 2009标准设计，目前卡在了SuperRotationSystem上

SRS系统属于重中之重，无法实现此系统意味着无法视线T-spin、J/L-spin等需要踢墙才能完成的强攻击，也无法引导AI进行对应地形构建，根据guideline，Tetris官方设计了严格的五点判断系统，每个方块在四个方向向各两个方向旋转时各有各自独立的五个旋转中心，其5个旋转可能结果依次先后判断，最优先达成的为最终旋转结果。为了避免将总共4x4x7x4x2=896种可能显示结果全部列出所导致的大量垃圾数据和难以估量的debug难度，设置名为kicklist的三维数组储存各形态下五点判断系统的位移量，与方块形态的基本数组搭配使用

但是在实际过程中发现，旋转判断经常会把方块旋入边界之外。

debug将动态图与静态图拆分显示，明明已经发生了碰撞，col_check(static_map, active_map)也返回了collide判断阻止旋转发生，但是尽管没有旋转，位移依旧会跳过函数循环强行发生，实在无法理解

<img src="J:\OneDrive\文档\Tetris实验报告\img\20200824_1.PNG" alt="20200824_1" style="zoom:50%;" />

跟踪绘制流程图和变量表 我就不信了

01点35分

进一步细化debug，发现临时储存kicklist碰撞判断用的map_temp数组出现了莫名其妙的继承性，明明在每个point的判断时都对其进行了刷新temp_mino[2][1] = cur_mino_L[2]，但是实际上却保留了上一次kicklist数据项对其位置坐标的修改，导致判断溢出到了墙外，离谱

好困，无法解释，决定研究一下lua的table结构 先把代码冻结起来

<img src="J:\OneDrive\文档\Tetris实验报告\img\20200824_2.PNG" alt="20200824_2" style="zoom:50%;" />

2020年8月25日 

09点15分 项目得到了批准，继续进行

考虑可能是cur_mino_L出于某些原因发生了修改，根坐标发生了刷新

查看love.update(dt)中，game_status_main == 2 循环判断中， 有

```
clear_map(map_L_active)
input()
refresh_map(map_L_active, cur_mino_L[1], cur_mino_L[2])
```

是不是有可能在input执行同时，并行执行了refresh导致cur_mino_L[2]更改？

设置了用户input阻断标志位 无改善

debug发现观察对象转为cur_mino_L后，确实发生了循环外的直接变化

![20200825_1](J:\OneDrive\文档\Tetris实验报告\img\20200825_1.PNG)



修改cur_kicklist观察全部过程的kicklist，发现嵌入墙体时，每一步都是(0,0)，也就是说col_check无误，排除

![20200825_2](J:\OneDrive\文档\Tetris实验报告\img\20200825_2.PNG)

那么位移到底是怎么发生的呢

把n=1,5循环中的坐标更新注释掉，居然还会嵌入，由于目前所有代码涉及cur_mino_L修改的只有此处，所以可以肯定是在循环开始的temp_mino赋值时对cur_mino发生了修正

10点15分

成功了

```lua
temp_mino[2] = {0,0}
temp_mino[2][1] = cur_mino_L[2][1] + kicklist[n][1] --更新
temp_mino[2][2] = cur_mino_L[2][2] + kicklist[n][2]```
```

每次刷新将temp_mino[2]归零 并取消中间级 直接调用cur_mino_L

验证：IJLOSZ全部通过SRS系统验证 T-spin验证通过（TSD）

SRS系统基本构建完成，以后再加入finess判断系统

代码解冻

着手制作Hard_drop系统和静态图更新逻辑

10点39分 hard_drop完成 为了进一步验证 先把7bag_sys完成

11点09分 开始将7bag增加为14位以提供在旧bag用尽后的新预见块组

11点25分 突然意识到TST未验证

验证未通过

忘了修I块以外的转向错误了

因为数组实际上是从上到下从小到大的，所以相对于文档中的位移，y值位移是相反的，之前一直在用I块做验证所以只修改了I块

好了 可以TST了



15点31分 继续

着手双缓冲14bag实现

15点54分 完成14bag

接下来实现预见块系统

17点25分 优化代码可扩展性时 发现lua的除法默认是产出小数的

```lua
local cur_dep = y/5+1 -- 1~depth+      
local dep_counter = bag_counter[side] + cur_dep --1+1 ~ 14+depth+1
local t = dep_counter%(bag_size*2) --化约dep_counter到1~14以内
temp_mino = pick_mino_next(rnd_bag[side][t/(bag_size+1)*0+1][0*(t-1)%7+1]) 
      --[side][d_c: 1~7 && 15~ :1 | 8~14 :2][d_c: 1~7:1~7 | 8~14:1~7]
```

输出：

```
(4,23):
curdep:5.6
dep_counter:5.6
pick_mino_next(rnd_bag[1][1][1]
```



我觉得我知道之前都是什么问题了

17点55分 优化 把各个函数优化成了包含(side)变量以区分左右玩家

将大量数组统一到一个数组中，这样可以用少量运算式来代替昂长的条件判断

``` lua t = (t)%(2*bag_size) + 1
t = (t)%(2*bag_size) + 1  
bag_counter[side] = t
return rnd_bag[side][1][(t-1)%bag_size+1]
```



现在问题是next列表显示的next和实际next之间差一个，又或者是有更多的问题，初步判断可能是在tempmino的minoID获取有差错，重新检查代码逻辑

00点07分 bag系统设计完成，错误不是next_bag的提取而是原本bag的分组分配在做优化的时候少修改了一个包位值

``` lua
function bag_pick(side) --side: 1:left 2:right
  local t = bag_counter[side]
  if t == 0 then
    refresh_bag(side, 1)
    refresh_bag(side, 2)
  elseif t == bag_size then
    refresh_bag(side, 1)
  elseif t == bag_size*2 then
    refresh_bag(side, 2)
  end
  t = (t)%(2*bag_size) + 1
  bag_counter[side] = t
  return rnd_bag[side][math.floor(t/(bag_size+1))+1][(t-1)%bag_size+1] 
                        --↑第二位↑ 修改前为1 导致取包永远在bag1与next_bag序列不对应
end
```



冻结，明天先把能优化的函数优化掉，再制作消行计分系统和SRS得分判断，构建static_map地形判断，准备制作AI



2020年8月26日 12点36分

完成了消行系统，中途遇到两个问题

其一，消行不是连续的，这一点写到一半的时候才意识到，一开始是打算在一个4格纵区间内消行，现在把代码重写变成了用一维数组储存四个行坐标来单个消行

```lua
function D_value_map(side) --获取动态图与静态图之间的差和部分 判断是否符合SRS特殊判定 增改计数器
  dif_rows = {0,0,0,0}
  local counter = 0 --再rows[]中定位消行坐标
  for i = 1+edge, height-edge do --按行搜索 所以先高后宽
    local row_counter = 0
    for j = 1+edge, width-edge do
      if maps[side][1][j][i] == true or maps[side][2][j][i] == true then
        row_counter = row_counter + 1
      end
    end
    --print("row counter:" .. row_counter .. "\n")
    if row_counter == width - 2*edge then --说明满行可消 2*edge因为要考虑左边墙厚度
      counter = counter + 1
      dif_rows[counter] = i
    end
  end
  print("dif_rows:(" .. dif_rows[1] .. "," .. dif_rows[2] .. "," .. dif_rows[3] .. "," .. dif_rows[4] .. ")")
  
  scoring(side, dif_rows) --根据当前值计算SRS系统赋分
  cleaning(side, dif_rows) --消行清理动态图与静态图
end
```



其二，for不能自动倒数，需要指定差值方向，lua正向for循环用多了已经快忘了还有这玩意

```lua
for y = r-1, 1+edge, -1 do --lua不能自动倒数 加上-1来确定差值方向
          if maps[side][1][x][y] == true then
            maps[side][1][x][y+1] = true
            maps[side][1][x][y] = false
          elseif maps[side][2][x][y] == true then
            maps[side][2][x][y+1] = true
            maps[side][2][x][y] = false
          end
        end
```

接下来首先还是把auto_repeat先完成，不然一下下按实在是太没效率了，好在之前已经预留了窗口，应该用不了多长时间

再上传到gemeshell检查一下可移植性，可能要重新规划一些图形坐标

接下来完成鬼影，排除所有原本的lining，用lining表示鬼影

再接下来是完善scoring()函数来完成SRS计分判断，要结合当前块和消行数，还要考虑T-spin、连击、back-to-back计数器来返回结果，还要考虑到以后交付给AI使用的泛用性

还有就是完成hold系统，可能要在7bag_sys.lua里面修改一下bag组

冻结



13点16分 吃完饭 auto_repeat完成了 触发灵敏度可在atr_time里设置，按照熟悉的手感调到了0.18s

14点02分 完成了显示窗口与各元素在不同环境下的等比缩放， 调整了界面布局 更换键位后上传到了gameshell的linux环境，检查低运算力下程序流畅度

14点21分 测试完成 完全流畅 开始设计鬼影

给所有key加上了side判断用于AI

15点17分 ghost完成 发现nextbag又有错误了 

？？？无法复现

15点25分 复现 发现是只有快节奏打块的时候会偶尔出现

debug显示bag与pick序列对应正确

![20200826_1](J:\OneDrive\文档\Tetris实验报告\img\20200826_1.PNG)

同时，检测到了不正常ghost行为：

![20200826_2](J:\OneDrive\文档\Tetris实验报告\img\20200826_2.PNG)

或许ghost还是有问题

重新捕捉到了bug

 <img src="J:\OneDrive\文档\Tetris实验报告\img\20200826_3.PNG" alt="20200826_3"  /><img src="J:\OneDrive\文档\Tetris实验报告\img\20200826_4.PNG" alt="20200826_4"  />

断口在46713...处，后接55321应为两处O块，但是第一张图next表第一位却显示了编号为4的L块 

观察左侧debug数据，此时bag_counter在13，next应取自bag2，与bag2中的5同列编号的在bag1中正好是4，说明发生了包偏移

观察代码

```lua
function update_next(side)
  for x = 1,4 do
    for y = 1, 5*depth do
      nextMap[side][x][y] = false
      local cur_dep = math.floor((y-1)/5)+1 -- 1~depth
      local dep_counter = bag_counter[side] + cur_dep --1+1 ~ 14+depth
      local t = dep_counter%(bag_size*2) --化约dep_counter到1~14以内
      temp_mino = pick_mino_next(rnd_bag[side][math.floor(t/(bag_size+1))+1][(t-1)%7+1]) 
            --[side][d_c: 1~7 && 15~ :1 | 8~14 :2][d_c: 1~7:1~7 | 8~14:1~7]
      if temp_mino[x][y%5] ~=0 and y%5 ~= 0 then
        nextMap[side][x][y] = true
        debug_true_check = debug_true_check + 1
      end
      love.graphics.print("cur_dep:" .. cur_dep .. "\ndep_counter:" .. dep_counter, 300, 100)
    end
  end
end
```

计算证实，在取bag_counter = 13时，对于cur_depth为1的第一个next方块，其 t 计算结果为0，而不是14，导致math.floor(t/(bag_size+1))+1得1，发生偏移

修正为

```lua
local t = (dep_counter-1)%(bag_size*2)+1
```

继续处理ghost问题

16点31分 ghost问题解决 因为未考虑屋檐所以导致了屋檐穿透

```lua
if temp_mino[j-x+1][k] ~= 0 and maps[side][1][j][i+k-1] == false and map_edge[j][i+k-1] == false then
          counter = counter+1
        elseif temp_mino[j-x+1][k] ~= 0 and (maps[side][1][j][i+k-1] == true or map_edge[j][i+k-1] == true) then
          counter_lock = true
          break
        end
```

增加额外counter_lock阻止在接触屋檐后继续下降

先跳过scoring系统，把hold写出来

17点08分 hold完成

17点16分 hold显示完成 



18点04分 闲着把刷新键写了 移植到gameshell开始排错

还不错 就是黑白界面有点费眼睛

<img src="J:\OneDrive\文档\Tetris实验报告\img\20200826_5.jpg" alt="20200826_5" style="zoom:25%;" />

00点30分 做了个UI界面 眼睛好受多了

![20200826_5](J:\OneDrive\文档\Tetris实验报告\img\20200826_5.PNG)

剩下是scoring系统和垃圾行生成器，然后是游戏结束条件（TopOut, LockOut, BlockOUT），也就是要再加20行buffer区

最后是攻击行计数器，可能还有重力系统，如果有时间的话

最后是AI侧的复现，用双组键位控制，最后添加上互锁两方各走一步

这周五左右应该就能完成，然后就能专心写搜索树了



2020年8月27日 08点57分 scoring

13点28分 scoring快写完了 等着debug 先想想怎么做后续的搜索方法

14点35分 完成了算法的初步设想 

DFS的最高运算量预估在300亿次左右  --> (hx4x4x4x10)^(next)

取高低差7，预见块3，最高运算速度下需要近9秒

NQL网络的训练低效而缺少参考样本

最后想到了一种方法，搜索底部边缘，分辨出可以落块的位置，然后逐个评估，边缘数预估在10~15之间，最高运算量在8.847亿次（取落块位15，预见块3），最大算力下用时0.25秒左右。最优/最常运算时间（取落块位10）为0.075秒

将最优位选定后，将其作为终点，对出生的tormino进行迷宫搜索算法（或者干脆直接放进去，不用一步一步走了）将其置入，固定，等待互锁解除



17点31分 终于完成了scoring系统

T-spin的判断逻辑比想象中还要难

除了ABCD方位判断和数组移位以外，还要求最后一步必须是旋转

根据https://tetris.fandom.com/wiki/T-Spin的解释



- 3-corner T, used in *[Tetris DS](https://tetris.fandom.com/wiki/Tetris_DS)* and other [SRS](https://tetris.fandom.com/wiki/SRS) based games: A T-spin bonus is awarded if all of the following are true:[[1\]](http://www.tetrisconcept.com/forum/viewtopic.php?t=78)

- 1. Tetromino being locked is T.
  2. Last successful movement of the tetromino was a rotate, as opposed to sideways movement, downward movement, or falling due to gravity. (Canceling lock delay in games that allow it, such as Tetris DS, does not count as a movement.) The tetromino doesn't even have to end up in a different orientation than it was dropped in; setting up the "well-known twist" below in *Tetris Worlds* or *Tetris DS* and pressing both rotate buttons (B–A or A–B) will trigger the T-spin bonus even without any net rotation.
  3. Three of the 4 squares diagonally adjacent to the T's center are occupied. In *Tetris DS*, the walls and floor surrounding the playfield are considered "occupied", while in *[Tetris Worlds](https://tetris.fandom.com/wiki/Tetris_Worlds)* for GBA, they aren't. Example:

| [![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)3-corner T-slot | [![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![TTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![TTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)[![CTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/4/42/CTet.png/revision/latest?cb=20200128093744)](https://vignette.wikia.nocookie.net/tetrisconcept/images/4/42/CTet.png/revision/latest?cb=20200128093744)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![TTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)Entry | [![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![BTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/6/6d/BTet.png/revision/latest?cb=20200128093738)](https://vignette.wikia.nocookie.net/tetrisconcept/images/6/6d/BTet.png/revision/latest?cb=20200128093738)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![Tet](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)](https://vignette.wikia.nocookie.net/tetrisconcept/images/1/18/Tet.png/revision/latest?cb=20200128093536)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![TTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)[![CTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/4/42/CTet.png/revision/latest?cb=20200128093744)](https://vignette.wikia.nocookie.net/tetrisconcept/images/4/42/CTet.png/revision/latest?cb=20200128093744)[![TTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![BTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/6/6d/BTet.png/revision/latest?cb=20200128093738)](https://vignette.wikia.nocookie.net/tetrisconcept/images/6/6d/BTet.png/revision/latest?cb=20200128093738)[![TTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)](https://vignette.wikia.nocookie.net/tetrisconcept/images/2/20/TTet.png/revision/latest?cb=20200128093753)[![BTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/6/6d/BTet.png/revision/latest?cb=20200128093738)](https://vignette.wikia.nocookie.net/tetrisconcept/images/6/6d/BTet.png/revision/latest?cb=20200128093738)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)[![GTet](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)](https://vignette.wikia.nocookie.net/tetrisconcept/images/8/88/GTet.png/revision/latest?cb=20200128093750)Rotated and 3 corners are occupied in the 3x3 box which contains the T |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
|                                                              |                                                              |                                                              |

[Different games](https://tetris.fandom.com/wiki/Guideline_compliant_game_differences) add further restrictions:

- 3-corner T no wall, used in *[Tetris Worlds](https://tetris.fandom.com/wiki/Tetris_Worlds)*: The walls and floor surrounding the playfield are not considered "occupied". This means that if a wall kick places the T tetromino with its flat side against the wall or floor, the T-spin will not be recognized. (Kicks that place the flat side against blocks in the playfield still work.)
- 3-corner T no kick, used in *[Tetris: New Century](https://tetris.fandom.com/wiki/Tetris:_New_Century)*, *[iPod Tetris](https://tetris.fandom.com/wiki/IPod_Tetris)*, *[Tetris Evolution](https://tetris.fandom.com/wiki/Tetris_Evolution)*, and most other official guideline games released from 2006-2008: The final rotation must not involve a wall kick, that is, it recognizes only the "well known twist" below.
- [Tetris Zone](https://tetris.fandom.com/wiki/Tetris_Zone) recognises T-spins that involve a wallkick, but will not recognise any T-spin that results in a triple.



The tetromino doesn't even have to end up in a different orientation than it was dropped in

说明T甚至可以旋转4次回到一开始的直降位置，也依旧被判断为T-spin

根据官方guideline

9.1.1  A rotation is considered a t-Spin if any of the following conditions are met:
 Sides A and B + (C or d) are touching a Surface when the tetrimino Locks down.•   the t-tetrimino fills a t-Slot completely with no holes.•  
 Rotation Point 5 is used to rotate the tetrimino into the t-Slot (see the •   super rotation system section in Appendix A). Any further rotation will be considered a t-Spin, not a Mini t-Spin. 

也是同样的说法，没有对是否回到初始态做出要求

接下来是垃圾行生成器和双方的攻击记录系统

优化了一下，又修了一些bug，包括计分逻辑和攻击逻辑的错误

现在有一个不常见的bug，有时候按HardDrop的时候方块会以另外一个旋转方向落下，似乎是ghost显示的与实际所处状态不符，感觉可能是按键震动的问题，bug目前还没法复现

19点24分 又出现了！

ghost转向了但是上方的待落块没有 说明是ghost功能的问题

也可能是串键了，慢点操作目前还没遇到问题

不是重大bug 先跳过

继续垃圾行生成器

20点12分 复现成功了！！！

在转向后hold 再出来的就会出现这种问题↓

![20200827_1](J:\OneDrive\文档\Tetris实验报告\img\20200827_1.PNG)

ghost继承了转向，但是新块没有，实际下降后也是没有转向的状态

注意到在holdBag为空时不会发生，所以一定是二者之间缺少了部分

```lua
function hold(side)
  if hold_bag == 0 then
    hold_bag = mino[side][1]
    clear_map(maps[side][2])
    cur_mino[side][1] = pick_mino(side) --获取新块
    cur_mino[side][2] = {6,edge} --设定初始位置
    game_status_main = 2 --进入下落状态
    update_next(side) --更新预见方块列表
    hold_checker[side] = 1
  else
    local temp = mino[side][1]
    mino[side][1] = hold_bag
    mino[side][2] = SOF --<--添加矫正初始方向 SOF = 1
    cur_mino[side][1] = pick_mino_next(hold_bag)
    hold_bag = temp
    cur_mino[side][2] = {6,edge} --设定初始位置
    hold_checker[side] = 1
  end
end
```

20点48分 修正bug

垃圾行输出器设计完成 借用了ghost的判断系统 当前块与地面距离为0时会和地面一起上升

21点41分 自我攻击系统验证完毕 准备开始设计双人模式

先冻结保险





目前进度：

双方静态图、动态图刷新

方块的移动，SRSkicklist系统，auto-repeat，7-bag系统，hold系统，重置系统，垃圾行生成器

T-spin/Tetris/normal计分器，攻击行交换器、接收交换器



YarpenMino -> 1236

Tetris.js -> 4768



目前的问题：

1.下、左、右移动的时候，因为每次判断都要先刷新一次activeMap来做碰撞判断，而这个时候锁定的话，似乎会把极限短时间内的移动也一并锁定，使得tormino形状改变，或需要增加一个新的map来储存它了

2.导出为.love文件运行的时候极为卡顿，卡得离谱，但是在编译环境下却没有问题，要么是对love理解有差，要么就是需要优化一波代码

3.combo还是有时候会莫名其妙地清零

00点50分 初步完成了双人的场地布置 现在功能都是齐全的 但是还没有试验过 互锁也没有开启



接下来：设定互锁回合制，设计终局条件（TopOut, LockOut, BlockOUT），为2号位设计对应按键控制验证完整性

然后开始搜索设计



<img src="J:\OneDrive\文档\Tetris实验报告\img\20200828_1.jpg" alt="20200828_1" style="zoom:25%;" />

15点42分 3号bug复现成功 用T消行连击的时候会把combo清零

15点46分 已修正

17点43分 完成了中间图 不会再出现异形固定了 1号bug修正

17点54分 优化keys.lua 减少了很多不需要的遍历判断 用中间图替代了很多 现在只有2次colCheck，省去了几十次的refresh

程序卡顿依旧严重，现在专心优化转向判断

转向优化完毕，依旧卡顿

离谱

18点47分 把所有的循环调用函数都检查一遍

19点55分 互锁初步完成 现在只有双方都完成操作之后，才能落下新块

攻击也会被抵消或者实例化

左边锁定之后按下h键固定右边

暂时还没有bug出现，先冻结起来



20点23分 绑定WASDQE到右边

目前的bug是右边无法下降到一定高度以下，这个高度取决于右边已有的行数

还有就是右边没有autorepeat

20点29分无法降高问题解决，down_press(2)的时候下降限定碰撞图没有改成maps[side]选择而是固定给了maps[1]

现在是双方的分数传送有问题，左边只能传给右边，而右边一不能传给左边，二不能消除自己的攻击值，判断可能是scoring下面的exchange出了问题

20点35分 啊这，temp[2]写成了temp2，赋值给了新建变量

20点50分 重新设置了主循环互锁机制，现在用同样的按键可以接连处理双方的落块了，autorepeat也可以，看来对按键的方向接口设计是成功的

接下来的问题是双方传递分数似乎并不是正确的数值，有时候单一无combo、BTB的Tetris会发送5行，而且似乎右边发送的总比左边少一行

21点25分 互锁增加了亮度效果，高亮一方为当前操作方

右边下降到一定高度后就只能旋转、锁定，而不能左右移动了

21点30分 结果发现又是key.lua有方向选择忘了改成side

我现在开始怀疑我的电脑在搞我的代码，每次我写完side都给我改回成1

就离谱



2020年8月29日 16点29分

完成了算法设计，开始完善代码

查了一下官方文档，lua中的table是以“对象”形式存在的，也就是

```lua
table1 = {2,2,2}
table2 = table1
table2[2] = 3
--则↓
table1 == {2,3,2}
```

故对旧table的克隆不可以用赋值的方法，而要用特别的克隆函数

```lua
-- Clones the given object and return it's copy.
-- @param object Table value to clone
-- @param deep Boolean indicating whether to do recursive cloning
-- @return Cloned table value

function clone(object, deep)
    local copy = {}
    for k, v in pairs(object) do
        if deep and type(v) == "table" then
             v = clone(v, deep)
        end
        copy[k] = v
    end
    return setmetatable(copy, getmetatable(object))
end
```

再次优化程序，对所有temptable进行释放等待lua的垃圾回收机制

17点30分 卡顿依旧无改善 设置lag计数器，当dt大于可接受范围（0.1s）时记录数据打印

算了 全都打印

21点17分 完成了基于matplotlib的数据分析 记录了四局的卡顿记录和各函数执行时间间隔相关关系

![Figure 2020-08-29 204936](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-29 204936.png)

![Figure 2020-08-29 210401](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-29 210401.png)

![Figure 2020-08-29 212317](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-29 212317.png)

![Figure 2020-08-29 212803](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-29 212803.png)

与表示时间间隔的红线所表现出的阶跃相关性越高，说明该函数运行对卡顿发生的贡献越大

分析结果显示D_value_map()，draw()，up_press()，rotate_key()四个函数相关性较强，说明问题可能发生在确认块落下后（up_press()）的计分过程（D_value_map）过程所导致的绘制（draw()）中

00点09分 资源管理器显示输出后的游戏文件占用内存在以每秒近四百兆的速度上升 bug定性为内存泄漏

从冻结库里查看所有阶段产出 freez_20200827_2148版本开始就有这个问题了，而之前的freez_20200827_0033版本则没有

根据日志，当天一连添加了scoring，exchange和generate系统，结合之前的分析，问题可能在scoring之中

同样需要意识到的是，随着内存占用增加，程序会愈发缓慢，而在编译环境下可以看到，上图中的时间间隔并没有一个持续的、规律的上升趋势，这说明编译环境下的内存管理是与打包后的成品有所区别的

而且，这么看的话，所有流程图中间隔时间达到一个最大卡顿值之前，都可以发现有一个微小的上升过程，这可能就是内存泄漏而逐渐积攒的一个短暂过程，然后上升到程序被系统所允许的最大值而被环境强行释放，直到下一次触发同样的问题导致内存占用继续上升为止

2020年8月30日 11点27分 一上午的调试 对 freez_20200827_2148 版本做出了内存泄漏的捕捉尝试，逐一禁用其与前一版本相差别的函数，在关闭scoring，exchange无效后，发现关闭draw_score(side)的情况下，内存不再泄漏，稳定在84M左右的占用

观察draw_score(side)，发现用于设置字体大小的font每次调用都使用了

```lua
local font = love.graphics.newFont("data/fonts/AdobeGothicStd.otf", 50*env)
love.graphics.setFont(font)
```

所以一直在循环内设置新的font，导致了内存泄漏

将newFont设置移交到init中，内存不再泄漏

取两局的运算间隔数值做表与之前对比，可以看到程序总体延迟明显下降

![](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-30 114716.png)

![](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-30 115157.png)

在第一局中后期阶段有两次0.5s和0.3s的大卡顿，但是在第二次运行中，全程下来总体卡顿最大值都没有超过0.05s，整体平均间隔保持在0.02s左右且捕捉函数用时与卡顿无明显相关性，暂时将两次大卡顿视为意外情况做保留处理

之前版本移植到gameshell上因为内存泄漏而导致死机，现在重新上传gameshell查看运算力是否支持

验证流畅，无明显卡顿，程序优化告一段落，冻结当前版本并继续设计AI

15点51分 AI递归逻辑验证完成 采用临时数组验证了AI可以独立完成落块

```lua

function AI_init()
  recurr_depth = 0
end


local function evaluate(egde, mino, map) --获取边缘位置坐标 当前mino编号 底层基本地形 返回result.score result.pos{x,y,dir} 其score值是四个方向中最大值并返回对应dir
  local result = {}
  result.score = 1
  result.pos = {5,2,1}
  --result.score result.pos{x,y,dir}
  return result
end

local function findEdge(map) --寻找图的边缘，返回所有可放置的坐标table {{x,y},{x,y}...}
  return {{5,2},{5,3},{5,4},{5,5},{5,6},{5,7}}
end
```

```lua

function AI_main(side, map, mino) --Mino取编号 不是table
  recurr_depth = recurr_depth + 1 --当前递归深度
  print("enter depth:" .. recurr_depth)
  local sch_map = clone(map, true)
  local edge = {} --{{x,y}, {x,y} ,{x,y}...} --获取边缘可放置坐标table
  edge = findEdge(sch_map)
  local i = 0
  local score_recurr = {} --记录递归中前AI_level个判断为估值score
  for i = 1, AI_level do
    score_recurr[i] = 0
  end
  local eval_res = {} --储存估值判断的结果score和位置pos
  for i = 1, #edge do
    eval_res[i] = evaluate(edge[i], mino, sch_map) --eval_res[i].score = score, eval_res[i].pos = {x,y,dir}
  end
  table.sort(eval_res,function(a,b) return a.score>b.score end ) --排序
  
  if recurr_depth < AI_level then
    for i = 1,AI_level do --取前几名用来递归
      print("under depth:" .. recurr_depth .. " eval i:" .. i)
      local recurr_map = clone(sch_map, true) --制作递归基础地形
      local cur_mino = AI_pick_mino(mino, eval_res[i].pos[3])
      refresh_map(recurr_map, cur_mino, {eval_res[i].pos[1],eval_res[i].pos[2]}) --进入下一步
      local recurr_mino = AI_get_next(side, recurr_depth) --按当前递归深度取对应mino
      score_recurr[i] = AI_main(side, recurr_map, recurr_mino) --递归
      print("score_recurr after: " .. table.concat(score_recurr))
    end
  else
    print("end at depth:" .. recurr_depth .. " with result:" .. eval_res[1].score)
    recurr_depth = recurr_depth - 1
    return eval_res[1].score --如果递归进行到最后一步 则返回最大值score对应项
  end
  if recurr_depth ~= 1 then
    table.sort(score_recurr,function(a,b) return a>b end ) --如果不是第一层则返回最大值即可
    recurr_depth = recurr_depth - 1
    return score_recurr[1]
  else 
    --排序score_recurr 取最大的值对应在eval_res里的pos返回
    for i = 1,AI_level do
      eval_res[i].score = score_recurr[i]
      table.sort(eval_res,function(a,b) return a.score>b.score end ) --如果不是第一层则返回最大值即可
    end
    return eval_res[1].pos --如果是第一层，则返回score综合最大值的pos{x,y,dir}
  end
  release(sch_map)
  release(edge)
  release(eval_res)
  release(recurr_map)
end
```

接下来只要按照需求完成对findEdge(map)和evaluate(edge, mino, map)的设计就可以了

```lua
local function evaluate(edge, mino, map) 
--获取边缘位置坐标 当前mino编号 底层基本地形 
--返回result.score result.pos{x,y,dir} 其score值是四个方向中最大值 对应dir

local function findEdge(map) 
--寻找图的边缘 
--返回所有可放置的坐标table {{x,y},{x,y}...}
```

先冻结一个版本出来

23点11分 边缘寻找函数完成了一半了 明天完成递归部分

2020年8月31日 13点47分 经过一上午的调试 AI已经可以获得Pierre Dellacherie中的高度值参数用于判断了

目前边缘搜索范围只在所有方向可能的垂直下落坐标中选择，未来再添加平移和落地SRS边缘坐标

和现在的AI打了几局对抗，AI明显在用倾向于最低高度差的方案落块，与参数属性相符

有一个问题是垃圾行生成有时候会补上原本存在的空洞 进一步测试generator发现这是常规bug而非特例bug

开始对garbage_gen检修

关闭掉空列生成功能后发现了静态图残留

![](J:\OneDrive\文档\Tetris实验报告\img\20200831_1.PNG)

在main循环中执行对动态图的清理，现在残留只剩下最后一次落下的方块了

![](J:\OneDrive\文档\Tetris实验报告\img\20200831_2.PNG)

进一步检查发现这个方块是动态图产物，在generator中清空动态图，问题解决

冻结版本 增加更多参数

对当前版本做了一下性能分析，在AI探索深度分别取4、5、6、7时，获得了如下图表：

![](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-31 145942.png)

![](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-31 150240.png)

![](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-31 150427.png)

![](J:\OneDrive\文档\Tetris实验报告\img\Figure 2020-08-31 150636.png)

AI每一步计算平均用时分别约为：0.01s\0.075s\0.92s\13.6s

呈指数递增，函数拟合结果取5.6^(-7) x e^(2.4x)

2020年9月2日 12点39分

发现了高度获取的一个小错误，只考虑到了4*4mino数组的位置，但没有考虑到其中每块的位置

完成了修改

完成了erodedPieceCellsMetric参数的获取

用控制台获取输出显示了在每个节点有消行（即erodedPieceCellsMetric~=0）时的反馈状态，验证该参数获取无误

```lua
mino:4
before
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□■■□□□□■□
□□□□■■■■■■■□
□□■■■■□□■■□□
□□□□□□□□□□□□

after
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□■■■□□□□■□
□■■■■■■■■■■□
□□■■■■□□■■□□
□□□□□□□□□□□□
landingHeight = 2
ePCM:3
dis_line:1
dis_mino:3

mino:4
before
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□■■□□□□■□
□□□□■■■■■■■□
□□■■■■□□■■□□
□□□□□□□□□□□□

after
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□□□□□□□□□
□□□□■■□□□□■□
□■■■■■■■■■■□
□■■■■■□□■■□□
□□□□□□□□□□□□
landingHeight = 1
ePCM:3
dis_line:1
dis_mino:3


......ETC
```

上述结果是在第二步落子后对后续4步进行递归预测而获得的，可以看到每一个参数结果都包含了一种可以在后四步之内消行的计划，但AI缺乏对自己决策的坚定性，在当前步骤计算出数步之后可以消行，但是在下一步却会因为计算出新的未来消行而放弃当前的计划，导致对前一个阶段最优的判断在下一个阶段不适用或者被抛弃，而最终没有一个计划得到执行。

希望在全部参数纳入考量后可以削减这种动摇性，不然就需要设计栈来阶段性打断判断储存计划了。

12点47分 在将预见性降低到未来一块后，AI的消行效率有所提高，接下来加入boardRowTransitions参数

13点30分 完成了boardRowTransitions boardColTransitions的参数获取

目前报错：

```lua
Program starting as '"C:\Program Files\love\love.exe" "J:\OneDrive\Product\Love2d\Tetris" -debug'.
Program 'love.exe' started in 'J:\OneDrive\Product\Love2d\Tetris' (pid: 5408).
Error: lib/AI_search.lua:231: attempt to index field 'pos' (a nil value)
stack traceback:
	[string "boot.lua"]:777: in function '__index'
	lib/AI_search.lua:231: in function 'AI_main'
	main.lua:170: in function 'update'
	[string "boot.lua"]:612: in function <[string "boot.lua"]:594>
	[C]: in function 'xpcall'
Program completed in 45.32 seconds (pid: 5408).
```

看来还是有nil值的pos没有被Evaluate捕捉转成{0,0,1}

14点27分 完成全部参数获取 开始检测

启用draw_debug_AI()获取决策步骤预测的全部参数

![](J:\OneDrive\文档\Tetris实验报告\img\20200902_1.PNG)

landingHeight无误

erodedPieceCellsMetric之前已验证正确

boardRowTransitions应为11，错误

boardColTransitions应为18，错误

好像行列写反了

14点48分 确实写反了，改过来了

boardBuriedHoles应为6，错误

boardWells应为4，错误

最后这两项使用了类似图像处理中滤波矩阵的方式将一个预制模板套上去比对来搜索埋藏洞与长洞

可能是模板没有到位，也有可能是table不能直接比对，检查一下

16点13分 基于Pierre Dellacherie算法的地形递归评估AI设计完成，算法已可以独自完成有效的消行与合理的堆叠

在搭建TST的时候发现无法二次右转，进而发现了在key.lua中rotate()函数有一处未修改1为dir，问题已修正

接下来是把用户方也交给AI，完成终局条件和自动重启与权重操作，然后添加更深的搜索和更多的评价参数，最后通过机器学习优化权重构建AI

最后再看能不能把操作入栈，再给思考加入延迟，这样以后可以解除互锁进行自由对战

16点46分 几局下来 AI输出和生存能力良好 操作方有一个问题，就是有时候左右移动能够出到edge范围外，可能是edge不够高导致的，因为复现的bug中出去的都是占格最少的O块，检查一下map.lua的边界矩阵设置

16点47分 冻结

17点31分 解除人工控制，将AI接入双边接口，成功构建AI对抗模式

18点01分 完成了终局判断，对局20次，依靠结果发现当前AI缺乏危机意识，也缺乏挖掘意识，因为在这个算法设计的时候是针对传统俄罗斯方块的，也就是没有垃圾行生成，没有对手，只要初始地形安排合理，就能够长时间坚持，所以AI不会有意识去挖掘到初始的最底层来清空垃圾行，也不会在濒临死亡线的时候积极消行，而是专心构建最优地形。但是垃圾行的对抗性打破了算法对地形的控制能力，所以许多时候对垃圾行的处理都是发生在算法运气好而正好打开了原先的最底层地形后，这个时候，底层积攒的垃圾行对于算法来说才是可见的。其他时候因为无法接触垃圾行，其产生的参数都是不论选择如何都无法改变的常量。

这说明要将地形整体高度、垃圾行量、对方的攻击和自己的生存（消行/垃圾行对抗）/攻击（构建地形/大攻击量计算）倾向程度纳入调整与判断范围。

根据自己的经验，在追求挖掘的时候，一般都要求“新落下的tetromino尽量不遮挡在其一下最近垃圾行空缺之上，避免原先的遮挡被消除后，又由于这一个mino而形成新的遮挡”，所以，当前mino距离下方洞口的距离应该是可以增强AI挖掘积极性的。

先扩展落地后移动/反转与已有edge的比对来扩大落子范围，完成一切基础设施之后，再添加和调节参数

也可以像我打块时一样，先预留一个空位来T-spin、Tetris或者连消，然后不断burn掉不需要的部分，直到等待的块到来，添加这样一个等待参量。

22点39分 添加了垂直下落后左右移动的新位置更新 目前算法还没有什么明显改进

或许是时候给每个edge元素添加一个移动序列了



2020年9月3日 10点47分 完成了SRS扩展搜索，开始添加操作栈

11点21分 完成了平移操作栈的录入 并且只录入第一递归深度避免资源浪费

```lua
local mid_maneuver_list = {} --操作栈 0:N\A 1:↑ 2:↓ 3:← 4:→ 5:左转 6:右转 7:hold

if depth == 1 then
          local l = 0
          local d_horz = i-6 --横移量
          for l = 1,(math.abs(d_horz)>0 and math.abs(d_horz) or 1)do
            table.insert(mid_maneuver_list,(d_horz>0 and 4) or (d_horz<0 and 3) or (0))
          end
          for l = 1,(temp_h-1>1 and temp_h or 1)do
            table.insert(mid_maneuver_list,2)
          end
          --print(table.concat(mid_maneuver_list))
          temp_pos[(i-1)*4+temp_dir] = {i,temp_h,temp_dir,mid_maneuver_list} 
    		--记录所有可以纵向落入的位置以及其操作栈
          mid_maneuver_list = {}
        else
          temp_pos[(i-1)*4+temp_dir] = {i,temp_h,temp_dir}
        end
```



控制台打印第一步第一层递归各项操作值

```lua
enter depth:1
333322222222222222222222
33322222222222222222222
3322222222222222222222
322222222222222222222
022222222222222222222
422222222222222222222
4422222222222222222222
44422222222222222222222
333332222222222222222222
33332222222222222222222
3332222222222222222222
332222222222222222222
32222222222222222222
02222222222222222222
42222222222222222222
442222222222222222222
4442222222222222222222
33332222222222222222222
3332222222222222222222
332222222222222222222
32222222222222222222
02222222222222222222
42222222222222222222
442222222222222222222
4442222222222222222222
33332222222222222222222
3332222222222222222222
332222222222222222222
32222222222222222222
02222222222222222222
42222222222222222222
442222222222222222222
4442222222222222222222
44442222222222222222222
enter depth:2
enter depth:3
enter depth:3
enter depth:3
...etc
```

接下来要录入在直降函数中的旋转相关

11点30分 旋转录入成功

```lua
enter depth:1
0333322222222222222222222
033322222222222222222222
03322222222222222222222
0322222222222222222222
0022222222222222222222
0422222222222222222222
04422222222222222222222
6333333222222222222222222
633333222222222222222222
63333222222222222222222
6333222222222222222222
633222222222222222222
63222222222222222222
60222222222222222222
64222222222222222222
644222222222222222222
6444222222222222222222
6633332222222222222222222
663332222222222222222222
66332222222222222222222
6632222222222222222222
6602222222222222222222
6642222222222222222222
66442222222222222222222
533333222222222222222222
53333222222222222222222
5333222222222222222222
533222222222222222222
53222222222222222222
50222222222222222222
54222222222222222222
544222222222222222222
5444222222222222222222
54444222222222222222222
enter depth:2
enter depth:3
enter depth:3
enter depth:3
enter depth:3
enter depth:3
enter depth:2
enter depth:3
enter depth:3
enter depth:3
enter depth:3
enter depth:3
enter depth:2
enter depth:3
enter depth:3
enter depth:3
enter depth:3
enter depth:3
```

接下来是实现操作函数功能，读取maneuver_list执行操作，删除直接刷新函数，回归操作系统

20点07分 完成了全部压栈和执行系统，修改了互锁系统，现在两方AI都可以具体操作了

该版本旨在验证操控是否合法，增添的额外计算量对机器学习效率无益，所以验证算法效力和学习时依旧使用上一版本

接下来是添加新的参数，设计参数评估，使用粒子群算法PSO完成新的参数学习和调试

还是有一个bug，mino依旧可能会冲到左右边缘外，而且还是不可刻意复现的

这合理🐴？

上边缘深入了3格，应该不会发生了

20点46分 开始设计参数

```lua
local v_max = 0.1 --速度最大值
local dim_num = 10 --每个粒子的维度数
local c1,c2 = 2,2 --学习因子

local function conjunction(value) --获取各维度评估值之评估和（不一定是纯相加）
	return num
end

local function PSO_eval(list, particle) --对particle在list中对应各维度值进行综合评估，获取对应粒子适应度/评估值
	return {num,num,num,num,...........,num}
end

local function PSO_recurr(vel, pos, value, pbest, gbest, recurr) --循环更新各粒子位置
	local i,j
	for i = 1,recurr do
		local w = 0.4--初始惯性权值
		for j = 1,2 do
			for k = 1,dim_num do
				vel[j][k] = w*vel[j][k]+c1*math.random()*(pbest[j][k]-pos[k][j])+c2*math.random()*(gbest-pos[k][j])
				vel[j][k] = vel[j][k]<vmax and vel[j][k] or vmax --限速
				pos[k][j] = pos[k][j]+vel[j][k] --更新位置
				pos[k][j] = (pos[k][j]>pos_edge_max and pos_edge_max) or (pos[k][j]<pos_edge_min and pos_edge_min) or pos[k][j] --限制范围
			end
		end
		for j = 1,2 do
		value[j] = PSO_eval(pos, j) --返回各个维度适应度/“位置”
		if conjunction(value[j]) > conjunction(pbest[j]) then --更新个体最优
			pbest[j] = value[j]
		end
		gbest = (pbest[1]>gbest and pbest[1]) or (pbest[2]>gbest and pbest[2]) or gbest --更新全域最优
	end


end

local function PSO_main()
	local pos = {} --位置
	local vel = {} --速度
	local i,j
	for i = 1, dim_num do
	    local start_pos = math.rand(0，100)
	    local start_vel = math.rand(0, 1)
	    pos[i] = {{start_pos},{start_pos}} --预置双方各维初始值为随机值
	    vel[i] = {{start_vel},{start_vel}} --预置双方各维初始速度为随机值
	end
	local pbest = {0,0} --personal best 个体最优值
	local gbest = 0 --global best 全域最优值
	
	local value = {{},{}} --各粒子各维度适应度/“位置”
	for j = 1,2 do
		value[j] = PSO_eval(pos, j) --返回各个维度适应度/“位置”
		if conjunction(value[j]) > conjunction(pbest[j]) then --初始个体最优
			pbest[j] = value[j]
		end
	end

	gbest = (pbest[1]>gbest and pbest[1]) or (pbest[2]>gbest and pbest[2]) or gbest --初始全域最优

	PSO_recurr(pos, vel, value, pbest, gbest, 100)

end
	


```

23点53分 伪代码设计完成↑



2020年9月4日 14点11分 添加以下参数

整体高度、垃圾行量 / 对方攻击

决定自己的生存（消行/垃圾行对抗）/攻击（构建地形/大攻击量计算）倾向程度

生存：新块对下方空洞的遮挡，可能消行数（不论单消）

攻击：可能攻击值（避免单消），可能combo数，可能T-spin，tetris



14点40分 突然意识到，对下一步的判断并没有添加上一步的消行，也就是下一步都是在上一步搭建的基础上计算的

15点05分 修复了这个问题

15点24分 完成了迭代combo计数器并将combo预测加入了value评估中

15点45分 完成了参数到PSO函数之间的传导

19点35分 完成了PSO，现在开始两个AI互相对抗依靠过程结果评估适应度并自行矫正各维度参数

20点53分 19点44分开始至此的61次对局调整参数得到的结果：

20:53:25
cur gbest: (601,-4.460666340453,4.8513630659877,-2.6014070443455,-9.846160292777,-6.4796770429685,-3.0975916744677,4.9995575686337,-1.0519974151775)

最高适应度601，适应度计算格式：

```lua
result = LPM[side] + math.abs(send_num[side]) - math.abs(recv_num[side]) +(side ~= lose and 100 or 0)
```

取每分钟消行数LPM加上发送行与接受行之差值

然后发现LPM忘了除以时间间隔了

......行8

20点57分 重新开始训练

22点02分 

47次训练结果：

```lua
22:02:14
cur gbest: (237.77551020408,-4.5,5.382483235682,-3.7494896882925,-9.3623994814628,-7.0700403763294,-2.5851705926831,4.0061430101917,-1.2302461433484)

```

此值在后续20次训练中不变，取此值重新开始训练，并增加输出项

23点06分

总计748次训练，267次开始value丢失，最终结果

```lua
23:05:44
cur gbest: (225.32,-4.5102679073614,5.3629362584813,-3.7919220162311,-9.3616541252144,-5.2841506712487,-2.6040140308313,3.987383247749,-1.2198732353142)
pos[1]: (-4.5102679073614,5.3629362584813,-3.7919220162311,-9.3616541252144,-5.2841506712487,-2.6040140308313,3.987383247749,-1.2198732353142)
pos[2]: (10,10,10,-9.3623331656037,10,10,10,-1.2189247196242)
p_best[1]: (225.32,-4.5102679073614,5.3629362584813,-3.7919220162311,-9.3616541252144,-5.2841506712487,-2.6040140308313,3.987383247749,-1.2198732353142)
p_best[2]: (224.21656050955,-4.5,5.382483235682,-3.7494896882925,-9.3623994814628,-7.0700403763294,-2.5851705926831,4.0061430101917,-1.2302461433484)
value: (nan,nan)
```

与前一版本进行对抗，结果是1：5的胜率，其中side1是修改后的算法

![](J:\OneDrive\文档\Tetris实验报告\img\20200904_1.PNG)

分析可能是因为原先版本消行随机而且不追求攻击力，根据当前版本的垃圾行生成器，一次攻击的量值会胜场一个同样深度的深洞，新训练版本追求的大量攻击会生成深度为4乃至8的洞，这种深洞一旦被旧版本挖出就可以用来直接发动消四的tetris攻击，而旧版本的遂计攻击大多攻击较小，生成的洞分散随机，不易挖掘。

接下来要么是修改垃圾行生成机制，要么对挖洞参数进行修改或进一步学习

先试一下修改垃圾行生成

这次胜率相对平均，5：4

![](J:\OneDrive\文档\Tetris实验报告\img\20200904_2.PNG)

修改了一些流程，重新训练

突然想到 既然胜负有一定的随机性，索性降低胜利的评估值加成如何？因为现在两方最后评估值相差都在50左右以内，而胜利的加成为100，可能走错了方向

00点46分 发现lose没有进入判断中，函数入口忘了改

```lua
local function PSO_eval(side) --此处应为(side,lose)
  local time = math.floor(ALL_endtime-ALL_starttime)/60
  local result = (LPM[side]/time) + math.abs(send_num[side]) - math.abs(recv_num[side]) +(side ~= lose and 100 or 0)
  return result
end
```

正好，这说明之前的评估都是不考虑输赢的

这次将输赢以10的权重加入训练

01点32分 vel还是会跑偏 明天继续修改



2020年9月5日 16点14分

发现了问题是因为每次修正值超过了vel修正速度的最大值，已经修改

从早上09:56:16至现在，6小时20分钟内迭代427次训练，其中有399项有效结果，最终最优值为：

```lua
16:14:22
cur gbest: (166.48101265823,-65.853832544498,21.290618856215,-32.90303699635,-100,-27.255888487513,-4.249740308313,46.00946127749,-17.347276272759)

pos[1]: (-65.853832544498,51.295005068026,-32.256783167341,-100,-27.254310895849,2.0497921718863,46.040111278138,-17.375644420325)
vel[1]: (0,4,0.67752297405189,0,0.0034113499545186,0,0.023634996468599,-0.047378023358204)
p_best[1]: (166.48101265823,-65.853832544498,21.290618856215,-32.90303699635,-100,-27.255888487513,-4.249740308313,46.00946127749,-17.347276272759)

pos[2]: (-3.6222680847141,81.558875375885,-51.726880650421,-100,3.0670163963742,-37.756878818178,-0.68336797250705,5.9936511037657)
vel[2]: (-1,3,-1,-1.8329973377793,5,-4,1.2,1)
p_best[2]: (157.91304347826,-47.612702270687,67.109541046541,-33.117974415048,-99.28384,-35.157173005567,-26.872396765039,-8.2723599725071,-6.0399332153073)

value: (nan,nan)
```

17点16分

调用最优参数，19局对抗结果为7 : 12

调用第二最优参数，35局对抗结果为17 : 18

尽管在对抗中观察到了对连击的趋向性，但是与训练前的随机连击相比无明显优势，对抗性无明显提升，且最优训练结果对抗性有所倒退，判定为训练适应度估值不当。

暂停训练调试，开始着手结题报告。

可能是send/recv的计算采用了相减的方式而使得AI产生了拖延对局以积攒send的趋向性，下一次训练的话将二者表现为相比较的相关性数值比较好。

还有一点，考虑到训练对局的随机性，下一次训练每次更新最优之前，或许应当执行10局取平均胜率判断最优，或者为了增加效率，可以取每10秒的评估值实时更新策略。



2020年10月8日 18点54分 

解决最上方左右横移溢出问题

观察到了一个Z块通过翻转搭到了右侧的边缘上，判断是collide的搜索范围问题

观察后发现确实如此，因为生成edge和整体map的时候采用了-2到width+2的生成范围，而collide和用于中介的midmap用的还是width作为宽度所有没有搜索到，纵向也同理

修改完成，目前没有再观察到同样的溢出问题